# This is a basic workflow to help you get started with Actions

name: CI-CD-pipeline-for-AWS

env:
  EB_PACKAGE_S3_BUCKET_NAME : "my-flaskapp"
  EB_application_name       : "flask-man"
  EB_environment_name       : "flaskman-env"
  DEPLOY_PACKAGE_NAME       : "flask-aman${{ github.sha }}.zip"
  AWS_Region_name           : "us-west-2"


# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [ main ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
   my_ci_pipeline:
    runs-on : ubuntu-latest
    
    steps:
      - name: Git clone our repo 
        uses: actions/checkout@v1
      
      - name: create zip package
        run: zip -r ${{ env.DEPLOY_PACKAGE_NAME }} ./ -x ".git"
        
      - name: configure AWS
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id : ${{ secrets.MY_AWS_ACCESS_KEY }}
          aws-secret-access-key : ${{ secrets.MY_AWS_SECRET_KEY }}
          aws-region : ${{ env.AWS_Region_name }}
      
      - name: copy deployment package to S3 bucket 
        run: aws s3 cp ${{ env.DEPLOY_PACKAGE_NAME }} s3://${{ env.EB_PACKAGE_S3_BUCKET_NAME}}/
         
      - name: success Message 
        run: echo "CI pipelines worked successfully "

   my_cd_pipeline:
    runs-on : ubuntu-latest
    needs: [my_ci_pipeline]
    
    steps:
      - name: configure AWS
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id : ${{ secrets.MY_AWS_ACCESS_KEY }}
          aws-secret-access-key : ${{ secrets.MY_AWS_SECRET_KEY }}
          aws-region : ${{ env.AWS_Region_name }}
          
      - name: create new elastic version      
        run : aws elasticbeanstalk create-application-version --application-name ${{ env.EB_application_name }} --source-bundle S3bucket="${{ env.EB_PACKAGE_S3_BUCKET_NAME }}", S3key="${{ env.DEPLOY_PACKAGE_NAME }}" --version-label "Ver-${{ github.sha }}" --description "CommitSHA-${{ "github.sha }}"
          
      - name: create new elastic version
        run: aws elasticbeanstalk update-environment --environment-name ${{ env.EB_environment_name  }} --version-label "Ver-${{ github.sha }}" 
        
      - name: success Message 
        run: echo "CD pipelines worked successfully "
